<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Calendar</title>
        <script src="http://code.jquery.com/jquery-latest.js"></script>
        <script>
            // 웹페이지 로드 후에 실행되는 코드
            $(() => {
                initFunction();
            });

            // 초기화 함수 (비동기 함수의 순서를 제어)
            async function initFunction() {
                try {
                    await saveCalendar();   // 서버에서 외부 api 데이터를 받아서 db에 저장
                    await fetchCalendar(); // 초기 캘린더 데이터 로드
                } catch(e) {
                    console.error('initFunction() Error', e);
                }
            }

            // 외부 api에서 데이터를 받아와서 db에 저장하라고 서버에 명령하는 함수
            async function saveCalendar() {
                try {
                    await $.ajax({
                        url: '/calendar/fetch',
                        type: 'GET',
                    });
                    await fetchCalendar();
                } catch(e) {
                    console.error('saveCalendar() Error', e);
                }
            }

            // 서버에서 캘린더 데이터를 받아오는 함수
            async function fetchCalendar() {
                try {
                    const response = await $.ajax({
                        url: '/calendar',
                        method: 'GET',
                    });

                    addCalendarHTML(response);  // 서버에서 받아온 캘린더 데이터로 최초 DOM 로드
                    response.forEach(calendar => {
                        updateRemainTime(calendar);   // 남은 시간 갱신
                    });

                    return response;
                } catch (e) {
                    console.error('Error fetching calendar', e);
                    return [];
                }
            };

            // 캘린더 데이터로 DOM을 구성하는 함수
            function addCalendarHTML(data) {
                $('#calendar').empty();

                const calendarHTML = data.map(calendar => {
                    let itemsHTML = calendar.items.map(item => `
                            <p>name === ${item.name}</p>
                            <p>icon === ${item.icon}</p>
                            <img src="${item.icon}" alt="itemIcon" />
                            <p>grade === ${item.grade}</p>
                    `).join('');

                    return `
                        <p>categoryName --- ${calendar.categoryName}</p>
                        <p>contentsIcon --- ${calendar.contentsIcon}</p>
                        <img src="${calendar.contentsIcon}" alt=contentsIcon />
                        <p>contentsName --- ${calendar.contentsName}</p>
                        <div>
                            ---------------------- items ------------------------
                            ${itemsHTML}
                            -------------------- items end ----------------------
                        </div>
                        <p>location --- ${calendar.location}</p>
                        <p>minItemLevel --- ${calendar.minItemLevel}</p>
                        <p>serverTime --- ${calendar.serverTime}</p>
                        <p id="remain-time-${calendar.sanitizedContentsName}"></p>
                        <p>startTimes --- ${calendar.startTimes}</p>
                        <hr>
                    `;
                }).join('');

                $('#calendar').append(calendarHTML);
            };

            // 남은 시간을 1초마다 갱신하는 함수
            function updateRemainTime(calendar) {
                const clientTime = new Date().getTime();                        // 클라이언트 시간
                const serverTime = new Date(calendar.serverTime).getTime();  // 서버 시간
                let timeOffset = clientTime - serverTime;           // 서버와 클라이언트의 시간 차이

                setInterval(() => {
                    const currentclientTime = new Date().getTime();       // 클라이언트 현재 시간
                    const adjustedTime = currentclientTime - timeOffset;  // 서버 시간에 맞춘 현재 시간
                    const nextStartTime = getValidStartTime(currentclientTime, calendar.startTimes);  // 현재 시간과 가장 가까운 일정
                    const remainTime = Math.floor((nextStartTime - adjustedTime) / 1000);  // 남은 시간 계산

                    // 각 컨텐츠의 남은 시간 태그를 갱신
                    $(`#remain-time-${calendar.sanitizedContentsName}`).text(`convertRemainTime --- ${convertRemainTime(remainTime)}`);
                }, 1000);
            }

            // 가장 가까운 시작 시간을 반환
            function getValidStartTime(currentclientTime, startTimes) {
                for (let prop in startTimes) {
                    let startTime = new Date(startTimes[prop]).getTime();

                    if(startTime - currentclientTime > 0) {
                        return startTime;
                    }
                }

                return 0;
            }

            // 초 단위의 시간을 "hh:mm:ss"로 변환
            function convertRemainTime(totalSeconds) {
                if (totalSeconds > 60 * 60 * 24) {
                    return `출현 대기 중`;
                };

                let hours = Math.floor(totalSeconds / 3600);
                totalSeconds %= 3600;
                let minutes = Math.floor(totalSeconds / 60);
                totalSeconds %= 60;
                let seconds = Math.floor(totalSeconds);

                // 각 단위를 2자리로 포맷팅
                // ex) 5:3:20이라면 05:03:20으로 포맷팅
                const formattedHours = String(hours).padStart(2, '0');
                const formattedMinutes = String(minutes).padStart(2, '0');
                const formattedSeconds = String(seconds).padStart(2, '0');

                return `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
            }
        </script>
    </head>
    <body>
        <div style="display: flex; justify-content: space-between;">
            <p style="font-size: 24px; font-weight: bold; margin: 0;">Calendars</p>
            <button type="button" onclick="window.location.href='/'">초기 화면으로</button>
        </div>
        <hr>

        <div id="calendar"></div>




        <!-- 여기에 remainTimes의 데이터 출력
        <h2>Remain Times</h2>
        <div th:each="entry : ${remainTimes}">
            <p th:text="'Key: ' + ${entry.key}"></p>
            <p th:text="'Content: ' + ${entry.value.contentsName}"></p>
            <p th:text="'Remain Time: ' + ${entry.value.remainTime}"></p>
        </div>

        <div th:each="cal : ${calendar}">
            <p th:text="'Contents Name: ' + ${cal.ContentsName}"></p>
            <img th:src="${cal.ContentsIcon}" alt="Contents Icon"/>
            <p th:text="'Category: ' + ${cal.CategoryName}"></p>
            <p th:text="'Location: ' + ${cal.Location}"></p>
            <p th:text="'Minimum Item Level: ' + ${cal.MinItemLevel}"></p>
            <p th:text="'Remain Time: ' + ${cal.remainTime}"></p>

            <h2>Start Times</h2>
            <ul>
                <li th:each="time : ${cal.startTimes}" th:text="${time}"></li>
            </ul>

            <h2>Reward Items</h2>
            <div th:each="rewardItem : ${cal.RewardItems}">
                <h3 th:text="'Item Level: ' + ${rewardItem.ItemLevel}"></h3>
                <ul>
                    <li th:each="item : ${rewardItem.Items}">
                        <p th:text="'Name: ' + ${item.Name}"></p>
                        <img th:src="${item.Icon}" alt="Item Icon"/>
                        <p th:text="'Grade: ' + ${item.Grade}"></p>
                    </li>
                </ul>
            </div>
            <hr style="border: 20px solid #555;">
        </div> -->
    </body>
</html>
